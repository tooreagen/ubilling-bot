require("dotenv").config();
const { Scenes } = require("telegraf");
const {
  mainKeyboard,
  financeKeyboard,
  techKeyboard,
  notAuthKeyboard,
  contactKeyboard,
  chatKeyboard,
} = require("../keyboards");
const { getUserAllInfo } = require("../controllers/getUserAllInfo");
const { getUserBalance } = require("../controllers/getUserBalance");
const { getUserPays } = require("../controllers/getUserPays");
const { userLogout } = require("../controllers/authentification");
const { logging } = require("../helpers/logging");
const { userCredit } = require("../controllers/userCredit");

const { BOT_NAME } = process.env;

const billingScene = new Scenes.BaseScene("billingScene");

//–ª–æ–≥ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
billingScene.use(async (ctx, next) => {
  const login = ctx.session.login;
  await logging("./log/allrequest.log", ctx, login);
  return next();
});

billingScene.enter(async (ctx) => {
  //–≤—Ö—ñ–¥ –≤ —Å—Ü–µ–Ω—É
  //–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –π–æ–≥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
  await ctx.replyWithHTML(`–í—ñ—Ç–∞—î–º–æ –≤ –±–æ—Ç—ñ <b>${BOT_NAME}</b>\n\n` + `–í–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ!`);

  await ctx.replyWithHTML(await getUserAllInfo(ctx.session.login));

  await ctx.replyWithHTML("‚ùóÔ∏è<b>–£–í–ê–ì–ê! –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –ø—Ä–∞—Ü—é—î –≤ —Ç–µ—Å—Ç–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ</b>‚ùóÔ∏è");

  await ctx.reply("üëá –í–∏–∫–æ–Ω–∞–π—Ç–µ –∑–∞–ø–∏—Ç:", mainKeyboard());
});

//–≤–∏–∫–ª–∏–∫ –≥–æ–ª–æ–≤–Ω–æ—ó –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –ø–æ –∫–æ–º–∞–Ω–¥—ñ –ù–ê–ó–ê–î
billingScene.hears("‚¨ÖÔ∏è–ù–∞–∑–∞–¥", async (ctx) => {
  await ctx.reply("üëá –í–∏–∫–æ–Ω–∞–π—Ç–µ –∑–∞–ø–∏—Ç:", mainKeyboard());
});

//–≤–∏–∫–ª–∏–∫ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ—ó –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
billingScene.hears("üí∏–§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó", async (ctx) => {
  await ctx.reply("üëá –í–∏–∫–æ–Ω–∞–π—Ç–µ –∑–∞–ø–∏—Ç:", financeKeyboard());
});

//–≤–∏–∫–ª–∏–∫ —Ç–µ—Ö–Ω—ñ—á–Ω–æ—ó –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
billingScene.hears("‚öôÔ∏è–¢–µ—Ö–Ω—ñ—á–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è", async (ctx) => {
  await ctx.reply("üëá –í–∏–∫–æ–Ω–∞–π—Ç–µ –∑–∞–ø–∏—Ç:", techKeyboard());
});

//–≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É
billingScene.hears("üí∞–ë–∞–ª–∞–Ω—Å", async (ctx) => {
  const login = ctx.session.login;
  await ctx.replyWithHTML(`–í–∞—à –±–∞–ª–∞–Ω—Å: <b>${await getUserBalance(login)} –≥—Ä–Ω.</b>`);
});

//–≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 10 –ø–ª–∞—Ç–µ–∂—ñ–≤
billingScene.hears("üìà–û—Å—Ç–∞–Ω–Ω—ñ –ø–ª–∞—Ç–µ–∂—ñ", async (ctx) => {
  const login = ctx.session.login;
  const paysMarkup = await getUserPays(login);

  ctx.replyWithHTML(`<b>–û—Å—Ç–∞–Ω–Ω—ñ 10 –ø–ª–∞—Ç–µ–∂—ñ–≤:</b>\n\n${paysMarkup}`);
});

//–≤–∑—è—Ç–∏ –∫—Ä–µ–¥–∏—Ç
billingScene.hears("ü§ë–ö—Ä–µ–¥–∏—Ç", async (ctx) => {
  const login = ctx.session.login;
  const response = await userCredit(login);
  ctx.replyWithHTML(response);
});

//–í–∏–∫–ª–∏–∫ –º–∞–π—Å—Ç—Ä–∞
billingScene.hears("üõ†–í–∏–∫–ª–∏–∫ –º–∞–π—Å—Ç—Ä–∞", async (ctx) => {
  ctx.replyWithHTML("–ö—É-–∫—É", 5230163004);
});

//–≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤
billingScene.hears("üìã–ö–æ–Ω—Ç–∞–∫—Ç–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞", async (ctx) => {
  ctx.replyWithHTML(
    `<b>üè¢ –ù–ê–®–ê –ê–î–†–ï–°–ê:</b>
–º. –ö–∞–ª—É—à, –≤—É–ª. –ë.–•–º–µ–ª—å–Ω–∏—Ü—å–∫–æ–≥–æ, 14\n
<b>üì± –¢–ï–õ–ï–§–û–ù–ò:</b>
(099) 565-44-48
(098) 565-44-48
(093) 565-44-48\n
<b>üìß –ï–õ–ï–ö–¢–†–û–ù–ù–ê –ü–û–®–¢–ê:</b>
manager@itlux.if.ua\n
<b>üìß –ß–ê–¢ –ó –ù–ê–ú–ò:</b>
https://t.me/ITlux_manager\n
<b>üïó –ì–†–ê–§–Ü–ö –†–û–ë–û–¢–ò</b>:
–ü–Ω-–ß—Ç –∑ 8:30 –¥–æ 18:00
–ü—Ç –∑ 8:30 –¥–æ 17:00
–°–± 9:00 –¥–æ 16:00
–ù–¥ –í–∏—Ö—ñ–¥–Ω–∏–π
`,
    { disable_web_page_preview: true }
  );
});

//–≤–∏–∫–ª–∏–∫ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –¥–ª—è –∑–≤'—è–∑–∫—É –∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
billingScene.hears("‚å®Ô∏è–ó–≤'—è–∑–æ–∫ –∑ –Ω–∞–º–∏", async (ctx) => {
  await ctx.reply("üëá –í–∏–∫–æ–Ω–∞–π—Ç–µ –∑–∞–ø–∏—Ç:", contactKeyboard());
});

//–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
billingScene.hears("‚å®Ô∏è–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è", async (ctx) => {
  await ctx.replyWithHTML(`–í–∏–∫–ª–∏–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞...`, chatKeyboard());
  return ctx.scene.enter("chatScene");
});

//—Å–∫–∞—Ä–≥–∞
billingScene.hears("ü§¨–ü–æ–¥–∞—Ç–∏ —Å–∫–∞—Ä–≥—É", async (ctx) => {
  ctx.replyWithHTML(
    `–í–∏ —Ç–∞–º —Å–æ–±—ñ –Ω–µ –≤–∏–¥—É–º—É–π—Ç–µ, –≤—Å–µ —É –≤–∞—Å –¥–æ–±—Ä–µ —ñ —Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å –≤–∞–º –Ω—ñ –Ω–∞ —à–æ. –•–∞–π —â–∞—Å—Ç–∏—Ç—å!`
  );
});

//–ø—Ä–æ–ø–∏–∑–∏—Ü—ñ—è –≤—ñ–¥ –∞–±–æ–Ω–µ–Ω—Ç–∞ –Ω–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É
billingScene.hears("üí°–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó —â–æ–¥–æ –±–æ—Ç–∞", async (ctx) => {
  ctx.replyWithHTML(
    `–Ø–∫—â–æ –í–∞–º –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –±–æ—Ç–∞, –Ω–∞–ø–∏—à—ñ—Ç—å –Ω–∞–º: <a href="https://t.me/ITlux_manager">–ù–∞–ø–∏—Å–∞—Ç–∏</a>`
  );
});

//—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∞–±–æ–Ω–µ–Ω—Ç–∞
billingScene.hears("ü§∑‚Äç‚ôÇÔ∏è–•—Ç–æ —è?", async (ctx) => {
  await ctx.replyWithHTML(await getUserAllInfo(ctx.session.login));
});

//–≤–∏—Ö—ñ–¥ –∑ –±–æ—Ç–∞
billingScene.hears("‚Ü©Ô∏è–í–∏—Ö—ñ–¥", async (ctx) => {
  const login = ctx.session.login;
  const chatId = ctx.chat.id;
  await ctx.replyWithHTML(await userLogout(login, chatId), notAuthKeyboard(), ctx.scene.leave());
  ctx.session.login = "";
  ctx.session.isAuth = false;
});

module.exports = { billingScene };
